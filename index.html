<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚ˆã£å‹ãƒ¡ãƒ¢ - Friend Memo</title>
    
    <link rel="icon" href="./icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon.png">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã‚ˆã£å‹ãƒ¡ãƒ¢">
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] },
                    colors: {
                        pastel: {
                            bg: '#FDFBF7', primary: '#A5B4FC', secondary: '#FDA4AF', surface: '#FFFFFF', text: '#475569',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* UIèª¿æ•´ */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 3px; }
        .emoji-radio:checked + label { background-color: #E0E7FF; border-color: #A5B4FC; transform: scale(1.1); }
        .view-btn.active { background-color: #E0E7FF; color: #6366F1; }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã®èƒŒæ™¯å›ºå®š */
        body.modal-open { overflow: hidden; }
        /* ã‚¹ãƒ ãƒ¼ã‚ºãªæ“ä½œæ„Ÿ */
        body { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body class="bg-pastel-bg text-pastel-text font-sans antialiased min-h-screen pb-24 relative safe-area-inset-bottom">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md shadow-sm border-b border-gray-100">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-500 flex items-center gap-2 select-none" onclick="window.scrollTo({top:0, behavior:'smooth'})">
                <span>ğŸ“</span> ã‚ˆã£å‹ãƒ¡ãƒ¢
            </h1>
            <div class="flex gap-2">
                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒœã‚¿ãƒ³ -->
                <button id="dataMenuBtn" class="text-gray-500 hover:text-indigo-600 bg-gray-50 hover:bg-indigo-50 px-3 py-1.5 rounded-full transition flex items-center gap-1 text-xs font-bold border border-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    ãƒ‡ãƒ¼ã‚¿
                </button>
                <button id="toggleFormBtn" class="text-sm bg-indigo-100 text-indigo-600 px-3 py-1.5 rounded-full hover:bg-indigo-200 transition font-medium">
                    ï¼‹ æ–°è¦
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 py-6 space-y-6">

        <!-- ç™»éŒ²ãƒ»ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
        <section id="formSection" class="bg-white rounded-2xl shadow-lg p-5 border border-indigo-50 hidden transition-all duration-300 transform origin-top">
            <h2 class="text-lg font-bold mb-4 text-gray-700 flex justify-between items-center">
                <span id="formTitle">å‹é”ã‚’ç™»éŒ²</span>
                <button type="button" id="closeFormBtn" class="text-gray-400 hover:text-gray-600 p-1">âœ•</button>
            </h2>
            
            <form id="friendForm" class="space-y-4">
                <input type="hidden" id="editId">

                <!-- ã‚¢ã‚¤ã‚³ãƒ³é¸æŠ -->
                <div>
                    <label class="block text-sm font-bold mb-2 text-gray-600">ã‚¤ãƒ¡ãƒ¼ã‚¸çµµæ–‡å­—</label>
                    <div class="flex items-center gap-3 mb-3">
                        <input type="text" id="emojiManualInput" class="w-16 h-16 text-3xl text-center bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-300 transition" placeholder="ğŸ˜Š" maxlength="2">
                        <div class="text-xs text-gray-400">
                            <span class="font-bold text-indigo-400">â†</span> ãƒªã‚¹ãƒˆé¸æŠã¾ãŸã¯<br>ç›´æ¥å…¥åŠ›
                        </div>
                    </div>
                    <div class="grid grid-cols-6 gap-2" id="emojiGrid"></div>
                </div>

                <!-- åå‰ & ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ  -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">åå‰ <span class="text-red-400">*</span></label>
                        <input type="text" id="nameInput" placeholder="å±±ç”° å¤ªéƒ" required class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">ã‚ã å</label>
                        <input type="text" id="nicknameInput" placeholder="ãŸã‚ã¡ã‚ƒã‚“" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition">
                    </div>
                </div>

                <!-- ç‰¹å¾´ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ç‰¹å¾´</label>
                    <input type="text" id="featureInput" placeholder="ã„ã¤ã‚‚å¸½å­ã‚’ã‹ã¶ã£ã¦ã‚‹" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition">
                </div>

                <!-- ã‚¿ã‚° -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                    <input type="text" id="tagsInput" placeholder="ã‚µãƒ¼ã‚¯ãƒ«, å­¦éƒ¨" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition">
                </div>

                <!-- ãƒ¡ãƒ¢ -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ãƒ¡ãƒ¢</label>
                    <textarea id="memoInput" rows="3" placeholder="è©³ç´°ãƒ¡ãƒ¢..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300 transition"></textarea>
                </div>

                <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                <div class="flex gap-3 pt-2">
                    <button type="button" id="cancelBtn" class="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">ã‚¯ãƒªã‚¢</button>
                    <button type="submit" id="saveBtn" class="flex-2 w-full py-3 bg-indigo-400 text-white rounded-xl font-bold shadow-md hover:bg-indigo-500 transition transform active:scale-95">ä¿å­˜ã™ã‚‹</button>
                </div>
                
                <!-- å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                <div id="deleteBtnArea" class="mt-4 pt-4 border-t border-gray-100 hidden">
                    <button type="button" id="deleteFromFormBtn" class="w-full py-2 text-red-400 hover:text-red-600 font-bold text-sm transition flex items-center justify-center gap-1">ã“ã®å‹é”ã‚’å‰Šé™¤</button>
                </div>
            </form>
        </section>

        <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ -->
        <section class="space-y-3">
            <div class="relative">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">ğŸ”</span>
                <input type="text" id="searchInput" placeholder="æ¤œç´¢..." class="w-full pl-10 pr-4 py-3 bg-white border border-gray-200 rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 transition text-sm">
            </div>
            <div class="overflow-x-auto pb-2 -mx-4 px-4 scrollbar-hide">
                <div class="flex gap-2" id="tagFilterContainer">
                    <button class="px-4 py-1.5 rounded-full text-xs font-bold bg-gray-700 text-white whitespace-nowrap transition" data-tag="ALL">ã™ã¹ã¦</button>
                </div>
            </div>
        </section>

        <!-- å‹é”ãƒªã‚¹ãƒˆ -->
        <section>
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-gray-500 text-sm">ç™»éŒ²ãƒªã‚¹ãƒˆ <span id="countBadge" class="ml-1 bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full text-xs">0äºº</span></h3>
                <div class="flex bg-gray-100 p-0.5 rounded-lg border border-gray-200">
                    <button id="viewListBtn" class="view-btn active px-2 py-1 rounded-md text-gray-400 hover:text-gray-600 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                    <button id="viewGridBtn" class="view-btn px-2 py-1 rounded-md text-gray-400 hover:text-gray-600 transition"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg></button>
                </div>
            </div>
            
            <ul id="friendList" class="space-y-4 pb-20"></ul>

            <div id="emptyState" class="hidden text-center py-10">
                <div class="text-4xl mb-3">ğŸƒ</div>
                <p class="text-gray-400 font-medium">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
            </div>
        </section>
    </main>

    <!-- FAB -->
    <button id="fabBtn" class="fixed bottom-6 right-6 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full p-4 shadow-xl transition transform hover:scale-110 md:hidden z-30 active:scale-95">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="dataModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
        <!-- èƒŒæ™¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="dataModalOverlay" class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity"></div>
        
        <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm relative z-10 overflow-hidden animate-fade-in-up">
            <div class="bg-indigo-50 p-4 border-b border-indigo-100 flex justify-between items-center">
                <h3 class="font-bold text-indigo-800 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path></svg>
                    ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                </h3>
                <button id="closeDataModalBtn" class="text-gray-400 hover:text-gray-600 p-1 bg-white rounded-full">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="p-5 space-y-6">
                <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">æ›¸ãå‡ºã—ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="copyJsonBtn" class="flex flex-col items-center justify-center gap-2 p-3 bg-gray-50 border border-gray-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 transition text-gray-600">
                            <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                            <span class="text-xs font-bold">ã‚³ãƒ”ãƒ¼</span>
                        </button>
                        <button id="downloadJsonBtn" class="flex flex-col items-center justify-center gap-2 p-3 bg-gray-50 border border-gray-200 rounded-xl hover:bg-indigo-50 hover:border-indigo-200 transition text-gray-600">
                            <svg class="w-6 h-6 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span class="text-xs font-bold">ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜</span>
                        </button>
                    </div>
                </div>

                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">èª­ã¿è¾¼ã¿ï¼ˆå¾©å…ƒï¼‰</h4>
                    <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-3 mb-3 flex gap-2 items-start">
                        <svg class="w-5 h-5 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <p class="text-[10px] text-yellow-800 leading-tight">
                            JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                            ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ããªã„å ´åˆã€èª­ã¿è¾¼ã¿ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™ã€‚
                        </p>
                    </div>
                    <input type="file" id="importInput" accept=".json,application/json" class="hidden">
                    <button id="importBtn" class="w-full py-3 border-2 border-dashed border-indigo-200 rounded-xl text-indigo-500 font-bold hover:bg-indigo-50 hover:border-indigo-400 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã‚€
                    </button>
                </div>
            </div>
            
            <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                <p class="text-[10px] text-gray-400">Version 1.1.1 - Icon Update</p>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šãƒ»å®šæ•° ---
        const EMOJI_LIST = ['ğŸ˜Š', 'ğŸ˜', 'ğŸ¤“', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ§', 'ğŸ˜´', 'ğŸ¤”', 'ğŸ˜‡', 'ğŸ¥º', 'ğŸ˜‚', 'ğŸ˜·', 'ğŸ“', 'âš½', 'ğŸ¸', 'ğŸ’»', 'ğŸ¨', 'âœˆï¸'];
        const STORAGE_KEY = 'yottomo_friends_db';

        // --- çŠ¶æ…‹ç®¡ç† ---
        let friends = [];
        let currentFilterTag = 'ALL';
        let searchQuery = '';
        let viewMode = 'list';

        // --- DOMè¦ç´  ---
        const els = {
            formSection: document.getElementById('formSection'),
            formTitle: document.getElementById('formTitle'),
            form: document.getElementById('friendForm'),
            toggleBtn: document.getElementById('toggleFormBtn'),
            closeBtn: document.getElementById('closeFormBtn'),
            fabBtn: document.getElementById('fabBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            saveBtn: document.getElementById('saveBtn'),
            emojiGrid: document.getElementById('emojiGrid'),
            inputs: {
                id: document.getElementById('editId'),
                name: document.getElementById('nameInput'),
                nickname: document.getElementById('nicknameInput'),
                feature: document.getElementById('featureInput'),
                tags: document.getElementById('tagsInput'),
                memo: document.getElementById('memoInput'),
                emojiManual: document.getElementById('emojiManualInput'),
            },
            list: document.getElementById('friendList'),
            emptyState: document.getElementById('emptyState'),
            countBadge: document.getElementById('countBadge'),
            searchInput: document.getElementById('searchInput'),
            tagFilterContainer: document.getElementById('tagFilterContainer'),
            viewBtns: {
                list: document.getElementById('viewListBtn'),
                grid: document.getElementById('viewGridBtn')
            },
            deleteBtnArea: document.getElementById('deleteBtnArea'),
            deleteFromFormBtn: document.getElementById('deleteFromFormBtn'),
            // ãƒ‡ãƒ¼ã‚¿ç®¡ç†é–¢é€£
            dataMenuBtn: document.getElementById('dataMenuBtn'),
            dataModal: document.getElementById('dataModal'),
            closeDataModalBtn: document.getElementById('closeDataModalBtn'),
            dataModalOverlay: document.getElementById('dataModalOverlay'),
            copyJsonBtn: document.getElementById('copyJsonBtn'),
            downloadJsonBtn: document.getElementById('downloadJsonBtn'),
            importInput: document.getElementById('importInput'),
            importBtn: document.getElementById('importBtn')
        };

        // --- åˆæœŸåŒ– ---
        function init() {
            renderEmojiPicker();
            loadFriendsFromStorage();
            renderTagFilters();
            renderList();
            setupEventListeners();
        }

        // --- ãƒ‡ãƒ¼ã‚¿æ“ä½œ (LocalStorage) ---
        function loadFriendsFromStorage() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (json) {
                try {
                    friends = JSON.parse(json);
                    friends.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                } catch(e) {
                    console.error('Data corrupted', e);
                    friends = [];
                }
            } else {
                friends = [];
            }
        }

        function saveToStorage() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(friends));
            loadFriendsFromStorage(); // å†ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚½ãƒ¼ãƒˆç­‰ã®ãŸã‚ï¼‰
            renderTagFilters();
            renderList();
        }

        function saveFriendData(friendData) {
            const now = new Date().toISOString();
            if (friendData.id) {
                const index = friends.findIndex(f => f.id === friendData.id);
                if (index !== -1) {
                    friends[index] = { ...friends[index], ...friendData, updatedAt: now };
                }
            } else {
                const newFriend = {
                    ...friendData,
                    id: crypto.randomUUID ? crypto.randomUUID() : 'id-' + Date.now() + Math.random(),
                    createdAt: now,
                    updatedAt: now
                };
                friends.push(newFriend);
            }
            saveToStorage();
            resetForm();
            toggleForm(false);
        }

        function deleteFriend(id) {
            if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            friends = friends.filter(f => f.id !== id);
            saveToStorage();
            if (!els.formSection.classList.contains('hidden')) toggleForm(false);
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½ï¼ˆJSONï¼‰ ---

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚³ãƒ”ãƒ¼ï¼‰
        function exportToClipboard() {
            const dataStr = JSON.stringify(friends, null, 2);
            navigator.clipboard.writeText(dataStr).then(() => {
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼\nãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªãªã©ã«è²¼ã‚Šä»˜ã‘ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
            }).catch(e => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e));
        }

        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼‰
        function exportToFile() {
            const dataStr = JSON.stringify(friends, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const date = new Date().toISOString().slice(0,10).replace(/-/g, '');
            a.href = url;
            a.download = `yottomo_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                    if (!Array.isArray(importedData)) {
                        throw new Error('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã§ã™ï¼ˆé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰');
                    }

                    // ãƒ¢ãƒ¼ãƒ‰é¸æŠ
                    const mode = confirm(
                        `èª­ã¿è¾¼ã¿ã«æˆåŠŸã—ã¾ã—ãŸï¼ˆ${importedData.length}ä»¶ï¼‰ã€‚\n\n` +
                        `ã€OKã€‘ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œã™ã¹ã¦æ¶ˆå»ã€ã—ã¦ç½®ãæ›ãˆã¾ã™ï¼ˆå¾©å…ƒãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚\n` +
                        `ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‘ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã«ã€Œè¿½åŠ ã€ã—ã¾ã™ï¼ˆãƒãƒ¼ã‚¸ãƒ¢ãƒ¼ãƒ‰ï¼‰ã€‚`
                    );

                    if (mode) {
                        // ä¸Šæ›¸ããƒ¢ãƒ¼ãƒ‰
                        friends = importedData;
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆç½®ãæ›ãˆï¼‰ã—ã¾ã—ãŸï¼');
                    } else {
                        // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ (IDãŒé‡è¤‡ã™ã‚‹ã‚‚ã®ã¯ä¸Šæ›¸ãã—ãªã„ã€ã‚ã‚‹ã„ã¯æ–°ã—ã„IDã«ã™ã‚‹ã‹...ä»Šå›ã¯å˜ç´”ã«çµåˆ)
                        // â€»åŒã˜IDã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä¸Šæ›¸ãã€ãªã‘ã‚Œã°è¿½åŠ ã¨ã„ã†è³¢ã„ãƒãƒ¼ã‚¸ã«ã™ã‚‹
                        let addedCount = 0;
                        let updatedCount = 0;
                        
                        importedData.forEach(newItem => {
                            const existingIndex = friends.findIndex(f => f.id === newItem.id);
                            if (existingIndex !== -1) {
                                // æ—¢å­˜ã«ã‚ã‚‹å ´åˆã¯ã€æ›´æ–°æ—¥æ™‚ãŒæ–°ã—ã„æ–¹ã‚’æ¡ç”¨ã™ã‚‹ã‹ï¼Ÿ
                                // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã€ã™ã‚‹
                                friends[existingIndex] = newItem;
                                updatedCount++;
                            } else {
                                friends.push(newItem);
                                addedCount++;
                            }
                        });
                        alert(`ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚\nï¼ˆæ–°è¦: ${addedCount}ä»¶ / æ›´æ–°: ${updatedCount}ä»¶ï¼‰`);
                    }

                    saveToStorage(); // ä¿å­˜ã—ã¦å†æç”»
                    toggleDataModal(false);

                } catch (err) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\næ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' + err.message);
                }
                // inputã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«ï¼‰
                els.importInput.value = '';
            };
            reader.readAsText(file);
        }

        // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
        function renderEmojiPicker() {
            if (!els.inputs.emojiManual.value) els.inputs.emojiManual.value = EMOJI_LIST[0];
            els.emojiGrid.innerHTML = EMOJI_LIST.map((emoji, index) => `
                <div class="relative">
                    <input type="radio" name="emoji" id="emoji-${index}" value="${emoji}" class="emoji-radio sr-only" ${index === 0 ? 'checked' : ''}>
                    <label for="emoji-${index}" class="block w-full aspect-square flex items-center justify-center text-xl bg-gray-50 border border-gray-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition select-none">
                        ${emoji}
                    </label>
                </div>
            `).join('');
        }

        function renderTagFilters() {
            const allTags = new Set();
            friends.forEach(f => {
                if(Array.isArray(f.tags)) f.tags.forEach(t => { if(t.trim()) allTags.add(t.trim()); });
            });
            const container = els.tagFilterContainer;
            while (container.children.length > 1) container.removeChild(container.lastChild);
            Array.from(allTags).sort().forEach(tag => {
                const btn = document.createElement('button');
                btn.className = `px-3 py-1.5 rounded-full text-xs font-bold border whitespace-nowrap transition flex-shrink-0 ${currentFilterTag === tag ? 'bg-indigo-400 text-white border-indigo-400' : 'bg-white text-gray-500 border-gray-200 hover:bg-indigo-50'}`;
                btn.textContent = `#${tag}`;
                btn.onclick = () => { currentFilterTag = tag; renderTagFilters(); renderList(); };
                container.appendChild(btn);
            });
            const allBtn = container.children[0];
            allBtn.className = `px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition flex-shrink-0 ${currentFilterTag === 'ALL' ? 'bg-gray-700 text-white' : 'bg-white text-gray-500 border border-gray-200 hover:bg-gray-100'}`;
        }

        function renderList() {
            let filtered = friends.filter(f => {
                if (currentFilterTag !== 'ALL') {
                    if (!f.tags || !f.tags.some(t => t.trim() === currentFilterTag)) return false;
                }
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    const tagsStr = Array.isArray(f.tags) ? f.tags.join(' ') : '';
                    const text = `${f.name} ${f.nickname} ${f.feature} ${f.memo} ${tagsStr}`.toLowerCase();
                    return text.includes(q);
                }
                return true;
            });
            
            els.list.innerHTML = '';
            els.countBadge.textContent = `${filtered.length}äºº`;
            els.list.className = viewMode === 'list' ? 'space-y-3' : 'grid grid-cols-2 gap-3 space-y-0';

            if (filtered.length === 0) els.emptyState.classList.remove('hidden');
            else {
                els.emptyState.classList.add('hidden');
                filtered.forEach(friend => els.list.appendChild(createCardElement(friend)));
            }
        }

        function createCardElement(friend) {
            const li = document.createElement('li');
            const tagsHtml = (friend.tags || []).map(tag => `<span class="inline-block bg-indigo-50 text-indigo-600 text-[10px] px-1.5 py-0.5 rounded mr-1 mb-1">#${tag}</span>`).join('');
            const memoHtml = (friend.memo || '').replace(/\n/g, '<br>');

            if (viewMode === 'list') {
                li.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-4 transition active:bg-gray-50';
                li.innerHTML = `
                    <div class="flex items-start gap-3" onclick="editFriend('${friend.id}')">
                        <div class="flex-shrink-0 w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center text-2xl shadow-inner">
                            ${friend.emoji}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-gray-800 text-base leading-tight">${friend.name}</h3>
                                    ${friend.nickname ? `<p class="text-xs text-indigo-500 font-medium">@${friend.nickname}</p>` : ''}
                                </div>
                            </div>
                            ${friend.feature ? `<div class="mt-1.5 text-xs text-gray-600 bg-gray-50 px-2 py-0.5 rounded border border-gray-100 inline-block truncate max-w-full">ğŸ’¡ ${friend.feature}</div>` : ''}
                            ${memoHtml ? `<div class="mt-2 text-xs text-gray-500 leading-relaxed border-t border-gray-100 pt-1 line-clamp-2">${memoHtml}</div>` : ''}
                            ${tagsHtml ? `<div class="mt-2 flex flex-wrap">${tagsHtml}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                li.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-3 transition active:bg-gray-50 h-full flex flex-col items-center text-center';
                li.onclick = () => editFriend(friend.id);
                li.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 bg-orange-50 rounded-full flex items-center justify-center text-2xl shadow-inner mb-2">
                        ${friend.emoji}
                    </div>
                    <h3 class="font-bold text-gray-800 text-sm leading-tight w-full truncate px-1">${friend.name}</h3>
                    ${friend.nickname ? `<p class="text-[10px] text-indigo-500 font-medium mb-1 truncate max-w-full">@${friend.nickname}</p>` : '<div class="mb-1 h-3"></div>'}
                    ${tagsHtml ? `<div class="mt-auto flex flex-wrap justify-center gap-0.5 w-full overflow-hidden h-5 opacity-80">${tagsHtml}</div>` : ''}
                `;
            }
            return li;
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---
        function toggleForm(show) {
            if (show) {
                els.formSection.classList.remove('hidden');
                els.fabBtn.classList.add('hidden');
                els.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                els.formSection.classList.add('hidden');
                els.fabBtn.classList.remove('hidden');
                resetForm();
            }
        }
        
        function toggleDataModal(show) {
            if (show) {
                els.dataModal.classList.remove('hidden');
                document.body.classList.add('modal-open');
            } else {
                els.dataModal.classList.add('hidden');
                document.body.classList.remove('modal-open');
            }
        }

        function resetForm() {
            els.form.reset();
            els.inputs.id.value = '';
            els.formTitle.textContent = 'å‹é”ã‚’ç™»éŒ²';
            els.saveBtn.textContent = 'ä¿å­˜ã™ã‚‹';
            els.deleteBtnArea.classList.add('hidden');
            els.inputs.emojiManual.value = EMOJI_LIST[0];
            const firstEmoji = document.getElementById('emoji-0');
            if(firstEmoji) firstEmoji.checked = true;
        }

        window.editFriend = function(id) {
            const friend = friends.find(f => f.id === id);
            if (!friend) return;
            els.inputs.id.value = friend.id;
            els.inputs.name.value = friend.name;
            els.inputs.nickname.value = friend.nickname;
            els.inputs.feature.value = friend.feature;
            els.inputs.tags.value = (friend.tags || []).join(', ');
            els.inputs.memo.value = friend.memo;
            els.inputs.emojiManual.value = friend.emoji || EMOJI_LIST[0];
            const radio = Array.from(document.querySelectorAll('.emoji-radio')).find(r => r.value === friend.emoji);
            if (radio) radio.checked = true;
            else document.querySelectorAll('.emoji-radio').forEach(r => r.checked = false);
            els.deleteBtnArea.classList.remove('hidden');
            els.formTitle.textContent = 'å‹é”æƒ…å ±ã‚’ç·¨é›†';
            els.saveBtn.textContent = 'æ›´æ–°ã™ã‚‹';
            toggleForm(true);
        };

        function setupEventListeners() {
            els.form.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = els.inputs.name.value.trim();
                if (!name) return;
                const friendData = {
                    id: els.inputs.id.value || null,
                    name: name,
                    nickname: els.inputs.nickname.value.trim(),
                    feature: els.inputs.feature.value.trim(),
                    memo: els.inputs.memo.value.trim(),
                    emoji: els.inputs.emojiManual.value.trim() || EMOJI_LIST[0],
                    tags: els.inputs.tags.value.split(/[,ã€\s]+/).filter(t => t.length > 0)
                };
                saveFriendData(friendData);
            });

            els.cancelBtn.addEventListener('click', () => resetForm());
            els.toggleBtn.addEventListener('click', () => toggleForm(true));
            els.fabBtn.addEventListener('click', () => toggleForm(true));
            els.closeBtn.addEventListener('click', () => toggleForm(false));
            
            // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            els.dataMenuBtn.addEventListener('click', () => toggleDataModal(true));
            els.closeDataModalBtn.addEventListener('click', () => toggleDataModal(false));
            els.dataModalOverlay.addEventListener('click', () => toggleDataModal(false));

            // ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            els.copyJsonBtn.addEventListener('click', exportToClipboard);
            els.downloadJsonBtn.addEventListener('click', exportToFile);
            els.importBtn.addEventListener('click', () => els.importInput.click());
            els.importInput.addEventListener('change', handleFileSelect);

            els.deleteFromFormBtn.addEventListener('click', () => {
                const id = els.inputs.id.value;
                if(id) deleteFriend(id);
            });

            els.searchInput.addEventListener('input', (e) => { searchQuery = e.target.value.trim(); renderList(); });
            els.tagFilterContainer.children[0].addEventListener('click', () => { currentFilterTag = 'ALL'; renderTagFilters(); renderList(); });

            els.emojiGrid.addEventListener('change', (e) => { if (e.target.name === 'emoji') els.inputs.emojiManual.value = e.target.value; });
            els.inputs.emojiManual.addEventListener('input', (e) => {
                const val = e.target.value;
                const radio = Array.from(document.querySelectorAll('.emoji-radio')).find(r => r.value === val);
                if (radio) radio.checked = true;
            });

            els.viewBtns.list.addEventListener('click', () => { viewMode = 'list'; els.viewBtns.list.classList.add('active'); els.viewBtns.grid.classList.remove('active'); renderList(); });
            els.viewBtns.grid.addEventListener('click', () => { viewMode = 'grid'; els.viewBtns.grid.classList.add('active'); els.viewBtns.list.classList.remove('active'); renderList(); });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

